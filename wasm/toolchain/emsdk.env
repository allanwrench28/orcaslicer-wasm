# Emscripten environment configuration
# Auto-generated by setup.ps1 (portable bash)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Prefer a native emsdk when under WSL/Linux to avoid Windows toolchain paths
if grep -qi microsoft /proc/version 2>/dev/null; then
    # WSL: favor $HOME/emsdk or /opt/emsdk
    if [ -z "${EMSDK:-}" ] && [ -f "$HOME/emsdk/emsdk_env.sh" ]; then
        EMSDK_PATH="$HOME/emsdk"
    elif [ -z "${EMSDK:-}" ] && [ -f "/opt/emsdk/emsdk_env.sh" ]; then
        EMSDK_PATH="/opt/emsdk"
    else
        EMSDK_PATH="${EMSDK:-$REPO_DIR/emsdk}"
    fi
else
    # Windows/Mac/Linux native
    EMSDK_PATH="${EMSDK:-$REPO_DIR/emsdk}"
fi

# Convert Windows path to Unix when under MSYS/Cygwin
if command -v cygpath >/dev/null 2>&1; then
    EMSDK_PATH="$(cygpath -u "$EMSDK_PATH")"
fi

if [ -f "$EMSDK_PATH/emsdk_env.sh" ]; then
    pushd "$EMSDK_PATH" >/dev/null 2>&1 || true
    # shellcheck disable=SC1091
    source "./emsdk_env.sh"
    popd >/dev/null 2>&1 || true
elif [ -f "/opt/emsdk/emsdk_env.sh" ]; then
    # shellcheck disable=SC1091
    source "/opt/emsdk/emsdk_env.sh"
else
    echo "Warning: Emscripten environment not found"
fi
